{
    "$schema":"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion":"1.0.0.0",
    "parameters":{
        "ARMlink":{
            "type": "string"
        },
        "VaultKey":{
            "type":"secureObject"
        }
    },
    "variables":{
       "ArtifactoriLink":"[parameters('ARMlink')]",
       "SecretName":"VM"
    },
    "resources":[
       {
          "name":"NSG-Deploy",
          "type":"Microsoft.Resources/deployments",
          "apiVersion":"2015-01-01",
          "properties":{
             "mode":"Incremental",
             "templateLink":{
                "uri":"[concat(variables('ArtifactoriLink'), 'nsg.json')]",
                "contentVersion":"1.0.0.0"
             },
             "parameters":{
 
             }
          }
       },
       {
          "name":"VirtualNetwork",
          "type":"Microsoft.Resources/deployments",
          "apiVersion":"2015-01-01",
          "properties":{
             "mode":"Incremental",
             "templateLink":{
                "uri":"[concat(variables('ArtifactoriLink'),'virtnet-with-pip.json')]",
                "contentVersion":"1.0.0.0"
             },
             "parameters":{
                "NSGid":{
                   "value":"[reference('NSG-Deploy').outputs.resourceID.value]"
                }
             }
          }
       },
       {
          "name":"StorageAccount",
          "type":"Microsoft.Resources/deployments",
          "apiVersion":"2015-01-01",
          "properties":{
             "mode":"Incremental",
             "templateLink":{
                "uri":"[concat(variables('ArtifactoriLink'),'storageaccount.json')]",
                "contentVersion":"1.0.0.0"
             },
             "parameters":{
 
             }
          }
       },
       {
          "name":"KeyVault",
          "type":"Microsoft.Resources/deployments",
          "apiVersion":"2015-01-01",
          "properties":{
             "mode":"Incremental",
             "templateLink":{
                "uri":"[concat(variables('ArtifactoriLink'),'keyvault.json')]",
                "contentVersion":"1.0.0.0"
             },
             "parameters":{
                "secretObject":{
                    "value":"[parameters('VaultKey')]"
                }
             }
          }
       },
       {
          "name":"VirtualMachine",
          "type":"Microsoft.Resources/deployments",
          "apiVersion":"2015-01-01",
          "dependsOn":[
             "VirtualNetwork"
          ],
          "properties":{
             "mode":"Incremental",
             "templateLink":{
                "uri":"[concat(variables('ArtifactoriLink'),'vmdeploy.json')]",
                "contentVersion":"1.0.0.0"
             },
             "parameters":{
                "SubnetID":{
                   "value":"[reference('VirtualNetwork').outputs.SubnetID.value]"
                },
                "PublicIPid":{
                   "value":"[reference('VirtualNetwork').outputs.PublicIPid.value]"
                },
                "StorAccNameOutput":{
                   "value":"[reference('StorageAccount').outputs.StorAccNameOutput.value]"
                },
                "adminPassword":{
                    "reference": {
                        "keyVault": {
                        "id": "[reference('KeyVault').outputs.KeyVaultId.value]"
                        },
                        "secretName": "[variables('SecretName')]"
                    }
                }
             }
          }
       }
    ],
    "outputs":{
 
    }
 }