{
    "$schema":"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion":"1.0.0.0",
    "parameters":{
       
    },
    "variables":{
       "ArtifactoriLink":"https://raw.githubusercontent.com/Nerwoolf/azure_arm/master",
       "SecretName":"Secret1Task4",
       "PSLink":"https://github.com/Nerwoolf/azure_arm/blob/master/vm/iissettingup.ps1.zip?raw=true"
    },
    "resources":[
       {
          "name":"NSG-Deploy",
          "type":"Microsoft.Resources/deployments",
          "apiVersion":"2015-01-01",
          "properties":{
             "mode":"Incremental",
             "templateLink":{
                "uri":"[concat(variables('ArtifactoriLink'), '/vm/nsg.json')]",
                "contentVersion":"1.0.0.0"
             },
             "parameters":{
 
             }
          }
       },
       {
          "name":"VirtualNetwork",
          "type":"Microsoft.Resources/deployments",
          "apiVersion":"2015-01-01",
          "properties":{
             "mode":"Incremental",
             "templateLink":{
                "uri":"[concat(variables('ArtifactoriLink'),'/vm/virtnet-with-pip.json')]",
                "contentVersion":"1.0.0.0"
             },
             "parameters":{
                "NSGid":{
                   "value":"[reference('NSG-Deploy').outputs.resourceID.value]"
                }
             }
          }
       },
       {
          "name":"StorageAccount",
          "type":"Microsoft.Resources/deployments",
          "apiVersion":"2015-01-01",
          "properties":{
             "mode":"Incremental",
             "templateLink":{
                "uri":"[concat(variables('ArtifactoriLink'),'/vm/storageaccount.json')]",
                "contentVersion":"1.0.0.0"
             },
             "parameters":{
 
             }
          }
       },
       {
          "name":"KeyVault",
          "type":"Microsoft.Resources/deployments",
          "apiVersion":"2015-01-01",
          "properties":{
             "mode":"Incremental",
             "templateLink":{
                "uri":"[concat(variables('ArtifactoriLink'),'/vm/keyvault.json')]",
                "contentVersion":"1.0.0.0"
             },
             "parameters":{
 
             }
          }
       },
       {
          "name":"VirtualMachine",
          "type":"Microsoft.Resources/deployments",
          "apiVersion":"2015-01-01",
          "dependsOn":[
             "VirtualNetwork"
          ],
          "properties":{
             "mode":"Incremental",
             "templateLink":{
                "uri":"[concat(variables('ArtifactoriLink'),'/vm/vmdeploy.json')]",
                "contentVersion":"1.0.0.0"
             },
             "parameters":{
                "SubnetID":{
                   "value":"[reference('VirtualNetwork').outputs.SubnetID.value]"
                },
                "PublicIPid":{
                   "value":"[reference('VirtualNetwork').outputs.PublicIPid.value]"
                },
                "StorAccNameOutput":{
                   "value":"[reference('StorageAccount').outputs.StorAccNameOutput.value]"
                },
                "adminPassword":{
                    "reference": {
                        "keyVault": {
                        "id": "[reference('KeyVault').outputs.KeyVaultId.value]"
                        },
                        "secretName": "[variables('SecretName')]"
                    }
                }
             }
          }
       },
       {
           "name": "VMExtension",
           "type": "Microsoft.Resources/deployments",
           "apiVersion": "2015-01-01",
           "properties": {
               "mode": "Incremental",
               "templateLink": {
                   "uri": "[concat(variables('ArtifactoriLink'), '/vm/vmextension.json')]",
                   "contentVersion": "1.0.0.0"
               },
               "parameters": {
                   "VMName":{
                       "value":"[reference('VirtualMachine').outputs.VMName.value]"
                   },
                   "PSArtifactLink":{
                       "value":"[variables('PSLink')]"
                   }
               }
           }
       }
    ],
    "outputs":{
 
    }
 }